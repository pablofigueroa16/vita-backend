generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USUARIOS Y AUTENTICACIN
// ============================================

model User {
  id            String  @id @default(uuid())
  cognitoUserId String  @unique
  email         String  @unique
  firstName     String?
  lastName      String?
  phone         String?

  // Roles
  role UserRole @default(USER)

  // Estados de verificaci贸n
  kycStatus  KYCStatus @default(NOT_VERIFIED)
  kybStatus  KYBStatus @default(NOT_VERIFIED)
  isVerified Boolean   @default(false) // true cuando KYC/KYB aprobado

  // Device tracking para checkout invisible y afiliados
  deviceFingerprint String?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  // Relaciones
  profile         UserProfile?
  kycVerification KYCVerification?
  kybVerification KYBVerification?
  affiliateLinks  AffiliateLink[]
  transactions    Transaction[]
  payoutRequests  PayoutRequest[]

  reservations Reservation[]


  @@index([email])
  @@index([cognitoUserId])
  @@index([role])
  @@index([kycStatus])
  @@index([kybStatus])
  @@map("users")
}

enum UserRole {
  USER // Usuario normal/cliente
  CREATOR // Creador de contenido (monetiza con afiliados)
  BUSINESS // Empresa/Marca (vende productos/servicios)
  ADMIN // Administrador de plataforma
}

// ============================================
// KYC VERIFICATION (DIDIT Integration)
// ============================================

model KYCVerification {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // DIDIT Integration
  diditSessionId       String? @unique
  diditVerificationUrl String?
  provider             String  @default("didit")

  // Estado y datos
  status         KYCStatus @default(PENDING)
  documentType   String?
  documentNumber String?
  country        String?

  // Retry mechanism
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  maxAttempts   Int       @default(3)

  // Metadata (JSON con respuesta completa de DIDIT)
  metadata  Json?
  documents Json? // Documentos verificados por DIDIT

  // Audit trail
  initiatedAt DateTime  @default(now())
  submittedAt DateTime?
  approvedAt  DateTime?
  rejectedAt  DateTime?
  expiresAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([userId])
  @@index([diditSessionId])
  @@map("kyc_verifications")
}

enum KYCStatus {
  NOT_VERIFIED // Usuario reci茅n creado
  PENDING // Sesi贸n DIDIT creada, esperando que usuario complete
  IN_PROGRESS // Usuario complet贸 formulario, DIDIT procesando
  APPROVED // Verificaci贸n exitosa ( tag visible)
  REJECTED // Verificaci贸n fallida (puede reintentar)
  EXPIRED // Sesi贸n DIDIT expir贸 sin completar
}

// ============================================
// KYB VERIFICATION (Sistema Propio - Revisi贸n Manual)
// ============================================

model KYBVerification {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Business information
  businessName String
  businessType BusinessType
  taxId        String       @unique
  country      String // ISO 3166-1 alpha-2

  // Legal representative
  legalRepresentative Json // {firstName, lastName, documentType, documentNumber, position, email, phone}

  // Documents (S3 URLs con metadata)
  documents Json // Array de {type, s3Key, s3Url, fileName, fileSize, mimeType, uploadedAt}

  // Review process
  status      KYBStatus @default(PENDING)
  reviewNotes String?   @db.Text
  reviewedBy  String? // Admin user ID

  // Timestamps
  initiatedAt DateTime  @default(now())
  submittedAt DateTime? // Cuando se marca como listo para revisi贸n
  reviewedAt  DateTime?
  approvedAt  DateTime?
  rejectedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([userId])
  @@index([country])
  @@index([businessType])
  @@map("kyb_verifications")
}

enum KYBStatus {
  NOT_VERIFIED // Cuenta business sin KYB iniciado
  PENDING // KYB iniciado, subiendo documentos
  UNDER_REVIEW // Documentos completos, revisi贸n en curso
  APPROVED // Verificaci贸n exitosa ( tag + puede recibir pagos)
  REJECTED // Verificaci贸n fallida (con notas)
  ADDITIONAL_INFO_REQUIRED // Se necesitan m谩s documentos o aclaraciones
}

enum BusinessType {
  LLC // Sociedad de Responsabilidad Limitada
  CORPORATION // Corporaci贸n
  SOLE_PROPRIETORSHIP // Propietario nico
  PARTNERSHIP // Sociedad
  COOPERATIVE // Cooperativa
  NGO // ONG
  OTHER // Otro
}

// ============================================
// USER PROFILE (Perfil Extendido)
// ============================================

model UserProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Informaci贸n personal adicional
  bio        String? @db.Text
  avatar     String? // URL de S3
  coverImage String? // URL de S3

  // Ubicaci贸n
  country    String?
  city       String?
  address    String?
  postalCode String?

  // Redes sociales
  socialLinks Json? // {instagram, tiktok, twitter, facebook, website}

  // Preferencias
  preferences Json? // Preferencias del usuario (notificaciones, idioma, etc)
  metadata    Json? // Metadata adicional

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("user_profiles")
}

// ============================================
// SISTEMA DE AFILIADOS (Referidos de Creadores)
// ============================================

model AffiliateLink {
  id        String @id @default(uuid())
  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id], onDelete: Cascade)

  // Producto/Servicio afiliado
  productId String? // ID del producto (referencia futura)
  serviceId String? // ID del servicio (referencia futura)

  // C贸digo de afiliado 煤nico
  affiliateCode String @unique

  // Comisi贸n (definida por la marca)
  commissionPercentage Decimal @db.Decimal(5, 2) // ej: 15.50%

  // Estad铆sticas
  clicks        Int     @default(0)
  conversions   Int     @default(0)
  totalEarnings Decimal @default(0) @db.Decimal(10, 2)

  // Estado
  status AffiliateLinkStatus @default(ACTIVE)

  // Timestamps
  activatedAt      DateTime  @default(now())
  deactivatedAt    DateTime?
  lastClickAt      DateTime?
  lastConversionAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([affiliateCode])
  @@index([status])
  @@index([productId])
  @@index([serviceId])
  @@map("affiliate_links")
}

enum AffiliateLinkStatus {
  ACTIVE // Link activo
  PAUSED // Pausado por el creador
  DEACTIVATED // Desactivado permanentemente
}

// ============================================
// TRANSACCIONES Y PAGOS
// ============================================

model Transaction {
  id     String @id @default(uuid())
  userId String // Usuario que realiz贸 la compra
  user   User   @relation(fields: [userId], references: [id])

  // Referencia de la orden
  orderId String? @unique

  // Montos
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // M茅todo de pago
  paymentMethod         String // stripe, cregis, etc.
  paymentProvider       String? // Provider espec铆fico
  externalTransactionId String? // ID de transacci贸n en el provider

  // Split de comisiones (JSON)
  splitDetails Json? // {brandAmount, creatorAmount, vitaAmount, affiliateCode}

  // Tracking de afiliado
  affiliateCode     String? // Si vino de un link de afiliado
  deviceFingerprint String? // Para tracking

  // Estado
  status TransactionStatus @default(PENDING)

  // Metadata adicional
  metadata Json? // Informaci贸n adicional de la transacci贸n

  // Timestamps
  processedAt DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([orderId])
  @@index([affiliateCode])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

enum TransactionStatus {
  PENDING // Pago iniciado
  PROCESSING // Procesando
  COMPLETED // Completado exitosamente
  FAILED // Fallido
  REFUNDED // Reembolsado
  CANCELLED // Cancelado
}

// ============================================
// TRACKING DE CLICKS DE AFILIADOS
// ============================================

model AffiliateClick {
  id            String @id @default(uuid())
  affiliateCode String

  // Device tracking (sin cookies)
  deviceFingerprint String
  ipAddress         String?
  userAgent         String?

  // Referrer info
  referrerUrl String?
  landingPage String?

  // Conversion tracking
  converted     Boolean   @default(false)
  convertedAt   DateTime?
  transactionId String?

  // Timestamps
  clickedAt DateTime @default(now())
  expiresAt DateTime // 30 d铆as desde el click

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([affiliateCode])
  @@index([deviceFingerprint])
  @@index([clickedAt])
  @@index([expiresAt])
  @@index([converted])
  @@map("affiliate_clicks")
}

// ============================================
// SOLICITUDES DE PAGO (Payouts de Creadores)
// ============================================

model PayoutRequest {
  id        String @id @default(uuid())
  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id])

  // Monto solicitado
  amount   Decimal @db.Decimal(10, 2)
  currency String  @default("USD")

  // M茅todo de pago preferido
  paymentMethod  PaymentMethodType
  paymentDetails Json? // {bankAccount, crypto wallet, etc}

  // Estado
  status      PayoutStatus @default(PENDING)
  reviewedBy  String? // Admin ID que revis贸
  reviewNotes String?      @db.Text

  // Timestamps
  requestedAt DateTime  @default(now())
  reviewedAt  DateTime?
  approvedAt  DateTime?
  paidAt      DateTime?
  rejectedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([creatorId])
  @@index([status])
  @@index([requestedAt])
  @@map("payout_requests")
}

enum PaymentMethodType {
  BANK_TRANSFER // Transferencia bancaria
  CRYPTO // Criptomoneda
  STRIPE // Stripe Connect
  CREGIS // Cregis
  OTHER // Otro m茅todo
}

enum PayoutStatus {
  PENDING // Pendiente de revisi贸n
  UNDER_REVIEW // En revisi贸n por admin
  APPROVED // Aprobado, pendiente de pago
  PAID // Pagado
  REJECTED // Rechazado
  CANCELLED // Cancelado por el creador
}

// ============================================
// SISTEMA DE RESERVAS
// ============================================

model Reservation {
  id         String @id @default(uuid())

  // Relaci贸n con el proveedor (puede ser USER o BUSINESS)
  providerId String
  provider   User   @relation(fields: [providerId], references: [id])

  // DATOS DEL CLIENTE
  customerName  String
  customerEmail String

  // Datos de la reserva
  date       DateTime
  startTime  String // "10:00"
  endTime    String // "11:00"

  // Estado de la reserva
  status ReservationStatus @default(CONFIRMED)

  // Metadata adicional (opcional)
  notes    String?
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([date])
  @@index([status])
  @@map("reservations")
}

enum ReservationStatus {
  CONFIRMED
  CANCELLED
  COMPLETED
  PENDING
}
